/*
 * @license
 * chartjs-plugin-streaming
 * https://github.com/nagix/chartjs-plugin-streaming/
 * Version: 1.4.1
 *
 * Copyright 2018 Akihiko Kusanagi
 * Released under the MIT license
 * https://github.com/nagix/chartjs-plugin-streaming/blob/master/LICENSE.md
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("moment")):"function"==typeof define&&define.amd?define(["chart.js","moment"],t):e["chartjs-plugin-streaming"]=t(e.Chart,e.moment)}(this,function(e,t){"use strict";!function(e,f){var h=e.helpers;h.cancelAnimFrame=function(){if("undefined"!=typeof window)return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){return window.clearTimeout(e)}}();var t,a,v=Number.MAX_SAFE_INTEGER||9007199254740991,y={millisecond:{common:!0,size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{common:!0,size:1e3,steps:[1,2,5,10,30]},minute:{common:!0,size:6e4,steps:[1,2,5,10,30]},hour:{common:!0,size:36e5,steps:[1,2,3,6,12]},day:{common:!0,size:864e5,steps:[1,2,5]},week:{common:!1,size:6048e5,steps:[1,2,3,4]},month:{common:!0,size:2628e6,steps:[1,2,3]},quarter:{common:!1,size:7884e6,steps:[1,2,3,4]},year:{common:!0,size:3154e7}},g=Object.keys(y);function w(e){for(var t=g.indexOf(e)+1,a=g.length;t<a;++t)if(y[g[t]].common)return g[t]}function s(e,t,a,i){var n,r=i.time,o=r.unit||function(e,t,a,i){var n,r,o,s=g.length;for(n=g.indexOf(e);n<s-1;++n)if(o=(r=y[g[n]]).steps?r.steps[r.steps.length-1]:v,r.common&&Math.ceil((a-t)/(o*r.size))<=i)return g[n];return g[s-1]}(r.minUnit,e,t,a),s=w(o),l=h.valueOrDefault(r.stepSize,r.unitStepSize),c="week"===o&&r.isoWeekday,u=y[o],m=f(e),d=f(t+i.realtime.refresh),p=[];for(l||(l=function(e,t,a,i){var n,r,o,s=t-e,l=y[a],c=l.size,u=l.steps;if(!u)return Math.ceil(s/(i*c));for(n=0,r=u.length;n<r&&(o=u[n],!(Math.ceil(s/(c*o))<=i));++n);return o}(e,t,o,a)),c&&(m=m.isoWeekday(c),d=d.isoWeekday(c)),m=m.startOf(c?"day":o),(d=d.startOf(c?"day":o))<t+i.realtime.refresh&&d.add(1,o),n=f(m),!s||c||r.round||(n.startOf(s),n.add(~~((m-n)/(u.size*l))*l,o));n<d;n.add(l,o))p.push(+n);return p.push(+n),p}void 0!==document.hidden?(t="hidden",a="visibilitychange"):void 0!==document.msHidden?(t="msHidden",a="msvisibilitychange"):void 0!==document.webkitHidden&&(t="webkitHidden",a="webkitvisibilitychange");var b={data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},x={data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]};function D(e,t,a){var i,n,r=e._start||{},o=e._view||{},s=e._model||{};for(i=0,n=t.length;i<n;++i){var l=t[i];r.hasOwnProperty(l)&&(r[l]-=a),o.hasOwnProperty(l)&&o!==r&&(o[l]-=a),s.hasOwnProperty(l)&&s!==o&&(s[l]-=a)}}var l=e.scaleService.getScaleConstructor("time");e.scaleService.getScaleConstructor=function(e){return"time"===e&&(e="realtime"),this.constructors.hasOwnProperty(e)?this.constructors[e]:void 0};var i=l.extend({initialize:function(){var m=this,d=m.chart;if(l.prototype.initialize.apply(m,arguments),"time"!==m.options.type||d.options.plugins.streaming){m.head=Date.now();var p=0;m.visibilityChangeListener=function(){document[t]||(d.update(0),m.head=Date.now())},document.addEventListener(a,m.visibilityChangeListener,!1);var f=function(){var r,e,o,t=m.options.realtime,a=t.duration,s=m.id,i=d.tooltip,n=i._active,l=1e3/(Math.max(t.frameRate,0)||30);m.isHorizontal()?(e=m.width,r=b):(e=m.height,r=x);var c=Date.now(),u=e*(c-m.head)/a;h.each(d.data.datasets,function(e,t){if(o=d.getDatasetMeta(t),s===o.xAxisID||s===o.yAxisID){var a,i,n=o.data||[];for(a=0,i=n.length;a<i;++a)D(n[a],r.data,u);o.dataset&&D(o.dataset,r.dataset,u)}}),n&&n[0]&&(o=d.getDatasetMeta(n[0]._datasetIndex),s!==o.xAxisID&&s!==o.yAxisID||D(i,r.tooltip,u)),m.max=m._table[1].time=c-t.delay,m.min=m._table[0].time=m.max-a,p+l<=c&&(d.animating||d.tooltip._start||d.draw(),t.onDraw&&t.onDraw(d),(p+=l)+l<=c&&(p=c)),m.head=c,m.frameRequestID=h.requestAnimFrame.call(window,f)};m.frameRequestID=h.requestAnimFrame.call(window,f)}},update:function(){var e=this,t=e.options;if("time"===t.type&&!e.chart.options.plugins.streaming)return l.prototype.update.apply(e,arguments);var a=t.realtime.pause,i=e.frameRequestID;return i||a?i&&a&&e.destroy():e.initialize(),l.prototype.update.apply(e,arguments)},buildTicks:function(){var e=this,t=e.options;if("time"===t.type&&!e.chart.options.plugins.streaming)return l.prototype.buildTicks.apply(e,arguments);var a=t.time,i=t.realtime,n=e.head-i.delay,r=n-i.duration,o=[];switch(t.ticks.source){case"data":o=e._timestamps.data;break;case"labels":o=e._timestamps.labels;break;case"auto":default:o=s(r,n,e.getLabelCapacity(r),t)}return e.min=r,e.max=n,e._unit=a.unit||function(e,t,a,i){var n,r,o=f.duration(f(i).diff(f(a)));for(n=g.length-1;n>=g.indexOf(t);n--)if(r=g[n],y[r].common&&o.as(r)>=e.length)return r;return g[t?g.indexOf(t):0]}(o,a.minUnit,e.min,e.max),e._majorUnit=w(e._unit),e._table=[{time:r,pos:0},{time:n,pos:1}],e._offsets={left:0,right:0},e._labelFormat=function(e,t){var a,i,n,r,o,s,l,c=e.length;for(a=0;a<c;a++){if(r=e[a],l=s=void 0,s=(o=t).parser,l=o.parser||o.format,0!==(i="function"==typeof s?s(r):"string"==typeof r&&"string"==typeof l?f(r,l):(r instanceof f||(r=f(r)),r.isValid()?r:"function"==typeof l?l(r):r)).millisecond())return"MMM D, YYYY h:mm:ss.SSS a";0===i.second()&&0===i.minute()&&0===i.hour()||(n=!0)}return n?"MMM D, YYYY h:mm:ss a":"MMM D, YYYY"}(e._timestamps.data,a),function(e,t){var a,i,n,r,o=[];for(a=0,i=e.length;a<i;++a)n=e[a],r=!!t&&n===+f(n).startOf(t),o.push({value:n,major:r});return o}(o,e._majorUnit)},fit:function(){var e=this,t=e.options;l.prototype.fit.apply(e,arguments),("time"!==t.type||e.chart.options.plugins.streaming)&&t.ticks.display&&t.display&&e.isHorizontal()&&(e.paddingLeft=3,e.paddingRight=3,e.handleMargins())},draw:function(e){var t=this,a=t.chart;if("time"!==t.options.type||a.options.plugins.streaming){var i=t.ctx,n=t.isHorizontal()?{left:e.left,top:0,right:e.right,bottom:a.height}:{left:0,top:e.top,right:a.width,bottom:e.bottom};h.canvas.clipArea(i,n),l.prototype.draw.apply(t,arguments),h.canvas.unclipArea(i)}else l.prototype.draw.apply(t,arguments)},destroy:function(){var e=this.visibilityChangeListener,t=this.frameRequestID;e&&(document.removeEventListener(a,e,!1),this.visibilityChangeListener=null),t&&(h.cancelAnimFrame.call(window,t),this.frameRequestID=null)}});e.scaleService.registerScaleType("realtime",i,{position:"bottom",distribution:"linear",bounds:"data",time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},realtime:{duration:1e4,refresh:1e3,delay:0,frameRate:30,pause:!1,onDraw:null},ticks:{autoSkip:!1,source:"auto",major:{enabled:!0}}})}(e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t);var a=function(c){var u=c.helpers;c.defaults.global.plugins.streaming={duration:1e4,refresh:1e3,delay:0,frameRate:30,pause:!1,onRefresh:null};var m=c.scaleService.getScaleConstructor("realtime");function d(e){var t=e.lastMouseMoveEvent;if(t)if("function"==typeof MouseEvent)e.canvas.dispatchEvent(t);else{var a=document.createEvent("MouseEvents");a.initMouseEvent(t.type,t.bubbles,t.cancelable,t.view,t.detail,t.screenX,t.screenY,t.clientX,t.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,t.relatedTarget),e.canvas.dispatchEvent(a)}}function p(e,t,a,i){var n,r;for(n=2,r=a.length;n<r&&e.getPixelForValue(null,n,i)<=t;++n);if(a.splice(0,n-2),"object"!=typeof a[0])return n-2}function a(a){var i,n,r,o,e,t,s,l=a.options.plugins.streaming;l.onRefresh&&l.onRefresh(a),a.data.datasets.forEach(function(e,t){(i=a.getDatasetMeta(t)).xAxisID&&(n=i.controller.getScaleForId(i.xAxisID))instanceof m&&(r=p(n,n.left,e.data,t)),i.yAxisID&&(n=i.controller.getScaleForId(i.yAxisID))instanceof m&&(r=p(n,n.top,e.data,t))}),r&&a.data.labels.splice(0,r),e=(o=a).options.animation,t=o.data.datasets,s=o.buildOrUpdateControllers(),t.forEach(function(e,t){o.getDatasetMeta(t).controller.buildOrUpdateElements()}),o.updateLayout(),e&&e.duration&&u.each(s,function(e){e.reset()}),o.updateDatasets(),o.animating?c.animationService.animations.forEach(function(e){e.chart===o&&o.render(16.66*(e.numSteps-e.currentStep))}):t.forEach(function(e,t){o.getDatasetMeta(t).controller.transition(1)}),o.tooltip._active&&o.tooltip.update(!0),d(o)}return{id:"streaming",afterInit:function(e,t){e.refreshTimerID=setInterval(function(){a(e)},t.refresh)},beforeUpdate:function(e,t){var a,i=e.options,n=i.scales;return n&&n.xAxes.concat(n.yAxes).forEach(function(e){"realtime"!==e.type&&"time"!==e.type||((a=e.realtime)||(a=e.realtime={}),a.duration=t.duration,a.refresh=t.refresh,a.delay=t.delay,a.frameRate=t.frameRate,a.pause=t.pause,a.onDraw=d,i.elements.line.capBezierPoints=!1)}),!0},beforeDatasetDraw:function(e,t){var a=t.meta,i=e.chartArea,n={left:0,top:0,right:e.width,bottom:e.height};return a.xAxisID&&a.controller.getScaleForId(a.xAxisID)instanceof m&&(n.left=i.left,n.right=i.right),a.yAxisID&&a.controller.getScaleForId(a.yAxisID)instanceof m&&(n.top=i.top,n.bottom=i.bottom),u.canvas.clipArea(e.ctx,n),!0},afterDatasetDraw:function(e){u.canvas.unclipArea(e.ctx)},beforeEvent:function(e,t){return"mousemove"===t.type?e.lastMouseMoveEvent=t.native:"mouseout"===t.type&&delete e.lastMouseMoveEvent,!0},destroy:function(e){var t=e.refreshTimerID;t&&clearInterval(t),u.each(e.scales,function(e){e instanceof m&&e.destroy()})}}}(e);return e.plugins.register(a),a});